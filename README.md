# colk-uv-distroless-python

A production-ready Dockerfile template for Python applications using [uv](https://docs.astral.sh/uv/), multi-stage builds, and [distroless](https://github.com/GoogleContainerTools/distroless) runtime images.

## Features

- **Multi-stage builds** - Optimized layer caching for fast rebuilds
- **Distroless runtime** - Minimal attack surface with no shell or package manager
- **uv package manager** - Fast, reliable Python package management
- **Multiple targets** - Development, testing, and production stages
- **Non-root execution** - Production images run as `nonroot` user
- **Python version flexibility** - Easily switch Python versions via build args

## Stages

| Stage | Base Image | Use Case |
|-------|-----------|----------|
| `developer` | Ubuntu 24.04 | Interactive development with shell access |
| `tester` | Distroless (nonroot) | Running tests in CI/CD |
| `runner` | Distroless (nonroot) | Production deployment |

## Prerequisites

Your project must have:

- `pyproject.toml` - Project configuration file
- `uv.lock` - Lock file generated by `uv lock`

## Usage

### Build for Production

```bash
docker build --target runner -t myapp:latest .
```

### Build for Testing

```bash
docker build --target tester -t myapp:test .
```

### Build for Development

```bash
docker build --target developer -t myapp:dev .
```

### Custom Python Version

```bash
docker build --build-arg PYTHON_VERSION=3.13 --target runner -t myapp:latest .
```

### Using Docker Compose

See [example.compose.yml](compose.example.yml) for a complete example.

```bash
# Development
docker compose -f compose.example.yml up dev

# Production
docker compose -f compose.example.yml up app
```

## Build Arguments

| Argument | Default | Description |
|----------|---------|-------------|
| `PYTHON_VERSION` | `3.14` | Python version to use |
| `UV_VERSION` | `0.7` | uv version (major.minor format) |
| `APP_DIR` | `/opt/app` | Application directory in container |
| `VENV_DIR` | `/opt/venv` | Virtual environment directory |

## Project Structure

```
your-project/
├── pyproject.toml      # Required: Project configuration
├── uv.lock             # Required: Lock file (run `uv lock` to generate)
├── Dockerfile          # Symlink to docker/python/Dockerfile
├── docker/
│   └── python/
│       └── Dockerfile  # The actual Dockerfile template
└── src/
    └── your_app/       # Your application code
```

## How It Works

1. **base_builder** - Installs production dependencies only (no source code)
2. **dev_builder** - Adds development dependencies on top of base_builder
3. **developer** - Ubuntu-based stage for interactive development
4. **tester** - Distroless stage with dev dependencies for running tests
5. **runner** - Minimal distroless stage for production

Source code is copied only in final stages, ensuring dependency cache is preserved when code changes.

## Notes

- **Health checks**: Distroless images lack curl/wget. Implement a `/health` endpoint in your application and use orchestrator health checks (e.g., Kubernetes probes).
- **Debugging**: Use the `developer` stage for debugging, which includes a shell and runs as root.
- **Security**: Production (`runner`) stage runs as `nonroot` user with minimal dependencies.

## License

MIT License - see [LICENSE](./LICENSE) for details.

## Author

[@Colk-tech](https://github.com/Colk-tech)
